name: Build and Release VSCode Extension

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.1)'
        required: true
        default: '1.0.1'
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install vsce
      run: npm install -g @vscode/vsce
      
    - name: Package extension
      run: vsce package --no-update-package-json
      
    - name: Get version from package.json
      id: get_version
      run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      
    - name: Get tag version
      if: startsWith(github.ref, 'refs/tags/')
      id: tag_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Use input version for manual trigger
      if: github.event_name == 'workflow_dispatch'
      id: input_version
      run: echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
      
    - name: Determine final version
      id: final_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "version=${{ steps.input_version.outputs.version }}" >> $GITHUB_OUTPUT
        elif [ "${{ github.event_name }}" == "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]; then
          echo "version=${{ steps.tag_version.outputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ steps.get_version.outputs.version }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Find VSIX file
      id: find_vsix
      run: echo "vsix_path=$(ls *.vsix | head -1)" >> $GITHUB_OUTPUT
      
    - name: Upload VSIX as artifact
      uses: actions/upload-artifact@v4
      with:
        name: evil-remote-ssh-agent-v${{ steps.final_version.outputs.version }}.vsix
        path: ${{ steps.find_vsix.outputs.vsix_path }}
        
    - name: Create Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.final_version.outputs.version }}
        name: Evil Remote SSH Agent v${{ steps.final_version.outputs.version }}
        body: |
          ## ğŸ‰ Evil Remote SSH Agent v${{ steps.final_version.outputs.version }} Release
          
          ### âš ï¸ é‡è¦å®‰å…¨è­¦å‘Š
          **æ­¤å·¥å…·ä»…ç”¨äºæ•™è‚²å’Œå®‰å…¨ç ”ç©¶ç›®çš„ï¼**
          
          ### ğŸ“‹ é¡¹ç›®è¯´æ˜
          è¿™æ˜¯ä¸€ä¸ªç”¨äºå®‰å…¨æ¼”ç¤ºçš„ VS Code æ‰©å±•ï¼Œæ—¨åœ¨è¯æ˜ä»¥ä¸‹å®‰å…¨é£é™©ï¼š
          
          **è¢«å…¥ä¾µçš„è¿œç¨‹è®¡ç®—æœºå¯èƒ½é€šè¿‡ VS Code Remote-SSH æ‰©å±•åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šæ‰§è¡Œæ¶æ„ä»£ç ã€‚**
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸŒ **HTTPæœåŠ¡å™¨**ï¼šè‡ªåŠ¨å¯åŠ¨HTTPæœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£8080ï¼‰
          - ğŸ–¥ï¸ **ç»ˆç«¯ç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºMouseå’ŒCatç»ˆç«¯
          - ğŸš€ **è¿œç¨‹å‘½ä»¤æ‰§è¡Œ**ï¼šé€šè¿‡HTTP APIæ‰§è¡Œè¿œç¨‹å‘½ä»¤
          - ğŸ“ **å‘½ä»¤æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰å‘½ä»¤æ‰§è¡Œå†å²
          - ğŸ”’ **éšè”½æ“ä½œ**ï¼šMouseç»ˆç«¯éšè—ï¼ŒCatç»ˆç«¯ç”¨äºæ©ç›–æ´»åŠ¨
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ \`evil-remote-ssh-agent-${{ steps.final_version.outputs.version }}.vsix\` æ–‡ä»¶
          2. åœ¨VS Codeä¸­æŒ‰ \`Cmd+Shift+P\` (Mac) æˆ– \`Ctrl+Shift+P\` (Windows/Linux)
          3. è¾“å…¥ \`Extensions: Install from VSIX...\`
          4. é€‰æ‹©ä¸‹è½½çš„VSIXæ–‡ä»¶è¿›è¡Œå®‰è£…
          
          ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
          #### æœåŠ¡å¯åŠ¨
          - å®‰è£…åæ‰©å±•ä¼šè‡ªåŠ¨å¯åŠ¨HTTPæœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£8080ï¼‰
          - ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªç»ˆç«¯ï¼š
            - **Mouseç»ˆç«¯**ï¼šéšè—çš„è¿œç¨‹ç»ˆç«¯ï¼Œç”¨äºæ‰§è¡Œå‘½ä»¤
            - **Catç»ˆç«¯**ï¼šå¯è§çš„æœ¬åœ°ç»ˆç«¯ï¼Œç”¨äºæ©ç›–Mouseç»ˆç«¯çš„æ´»åŠ¨
          
          #### å‘½ä»¤æ‰§è¡Œ
          é€šè¿‡HTTP APIå‘é€å‘½ä»¤è¯·æ±‚ï¼š
          ```bash
          # GETè¯·æ±‚ç¤ºä¾‹
          curl "http://localhost:8080/cmd?command=whoami"
          
          # POSTè¯·æ±‚ç¤ºä¾‹
          curl -X POST "http://localhost:8080/cmd" -d "command=ls -la"
          
          # å¥åº·æ£€æŸ¥
          curl "http://localhost:8080/health"
          ```
          
          ### ğŸ”§ å¿«æ·é”®
          - \`Cmd+Shift+R\` - åˆ›å»ºè¿œç¨‹ç»ˆç«¯
          - \`Cmd+Shift+S\` - å¯åŠ¨HTTPæœåŠ¡å™¨
          - \`Cmd+Shift+Q\` - åœæ­¢HTTPæœåŠ¡å™¨
          
          ### ğŸ“‹ APIç«¯ç‚¹
          - \`GET /health\` - å¥åº·æ£€æŸ¥
          - \`GET/POST /cmd?command=<command>\` - æ‰§è¡Œè¿œç¨‹å‘½ä»¤
          - \`GET /\` - APIä¿¡æ¯
          
          ### ğŸ›¡ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹
          - **ä»…ç”¨äºæ•™è‚²å’Œå®‰å…¨ç ”ç©¶ç›®çš„**
          - **è¯·ä»…è¿æ¥åˆ°æ‚¨å®Œå…¨ä¿¡ä»»çš„è¿œç¨‹è®¡ç®—æœº**
          - **ä¸¥ç¦åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–ä¸å—ä¿¡ä»»çš„ç½‘ç»œä¸­ä½¿ç”¨**
          - **ä½¿ç”¨å‰è¯·ç¡®ä¿æ‚¨äº†è§£ç›¸å…³å®‰å…¨é£é™©**
          
          ### ğŸ“š ç›¸å…³èµ„æº
          - [Vibe Hacking: Abusing Developer Trust](https://blog.calif.io/p/vibe-hacking-abusing-developer-trust)
          - [VS Code SSH WTF](https://fly.io/blog/vscode-ssh-wtf/)
          
          ### ğŸ”— ç›¸å…³é¡¹ç›®
          åŸºäº [evil-remote-ssh-agent](https://github.com/Fz0x00/evil-remote-ssh-agent) é¡¹ç›®è¿›è¡Œå¼€å‘ã€‚
          
          ---
          **å…è´£å£°æ˜**: æ­¤å·¥å…·ä»…ç”¨äºå®‰å…¨ç ”ç©¶å’Œæ•™è‚²ç›®çš„ã€‚ä½¿ç”¨è€…éœ€è¦è‡ªè¡Œæ‰¿æ‹…ä½¿ç”¨é£é™©ï¼Œå¼€å‘è€…ä¸å¯¹ä»»ä½•è¯¯ç”¨æˆ–æ»¥ç”¨è¡Œä¸ºè´Ÿè´£ã€‚
        files: ${{ steps.find_vsix.outputs.vsix_path }}
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update package.json version for manual trigger
      if: github.event_name == 'workflow_dispatch'
      run: |
        npm version ${{ steps.final_version.outputs.version }} --no-git-tag-version
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add package.json
        git commit -m "Bump version to ${{ steps.final_version.outputs.version }}"
        git push
        
    - name: Create tag for manual trigger
      if: github.event_name == 'workflow_dispatch'
      run: |
        git tag v${{ steps.final_version.outputs.version }}
        git push origin v${{ steps.final_version.outputs.version }}
